<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysX Client Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
        }
        .info { background: #264f78; }
        .success { background: #1e5e1e; }
        .error { background: #5e1e1e; }
        .warn { background: #5e5e1e; }
        #status {
            font-size: 1.2em;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .loading { background: #264f78; }
        .loaded { background: #1e5e1e; }
        .failed { background: #5e1e1e; }
    </style>
</head>
<body>
    <h1>PhysX Client Loading Test</h1>
    <div id="status" class="loading">Status: Initializing...</div>
    <div id="logs"></div>

    <script type="module">
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');

        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }

        function updateStatus(message, state) {
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = state;
        }

        async function testPhysXLoading() {
            try {
                log('Starting PhysX client test...');
                updateStatus('Loading PhysX...', 'loading');

                // Test 1: Load PhysX module directly
                log('Test 1: Loading PhysX module...');
                const startTime = performance.now();

                // Import PhysXManager
                const { loadPhysX, waitForPhysX, getPhysX, isPhysXReady } = await import('./build/index.js');

                // Check initial state
                log(`Initial PhysX ready state: ${isPhysXReady()}`);

                // Load PhysX
                const physxInfo = await waitForPhysX('ClientTest', 15000);
                const loadTime = performance.now() - startTime;
                
                log(`PhysX loaded in ${loadTime.toFixed(2)}ms`, 'success');
                log(`PhysX version: ${physxInfo.version}`, 'success');

                // Test 2: Verify PHYSX global
                const PHYSX = getPhysX();
                if (!PHYSX) {
                    throw new Error('PHYSX global not available after loading');
                }
                log('PHYSX global is available', 'success');

                // Test 3: Create basic physics objects
                log('Test 3: Creating physics objects...');
                
                // Create a transform
                const transform = new PHYSX.PxTransform(PHYSX.PxIDENTITYEnum.PxIdentity);
                log('Created PxTransform', 'success');

                // Create geometry
                const boxGeometry = new PHYSX.PxBoxGeometry(1, 1, 1);
                log('Created PxBoxGeometry', 'success');

                // Create material
                if (physxInfo.physics) {
                    const material = physxInfo.physics.createMaterial(0.5, 0.5, 0.6);
                    log('Created PxMaterial', 'success');

                    // Create a rigid body
                    const rigidBody = physxInfo.physics.createRigidDynamic(transform);
                    log('Created PxRigidDynamic', 'success');

                    // Test 4: Verify pose operations
                    const pose = rigidBody.getGlobalPose();
                    if (pose && pose.p && pose.q) {
                        log(`Rigid body position: (${pose.p.x}, ${pose.p.y}, ${pose.p.z})`, 'success');
                        log(`Rigid body quaternion: (${pose.q.x}, ${pose.q.y}, ${pose.q.z}, ${pose.q.w})`, 'success');
                    } else {
                        log('Warning: Pose structure not as expected', 'warn');
                    }
                }

                // Test 5: Test idempotency
                log('Test 5: Testing idempotent loading...');
                const secondLoadStart = performance.now();
                await loadPhysX();
                const secondLoadTime = performance.now() - secondLoadStart;
                log(`Second load completed in ${secondLoadTime.toFixed(2)}ms (should be instant)`, 'success');

                // Test 6: Verify THREE.js extensions
                if (window.THREE) {
                    log('THREE.js is available', 'success');
                    // Check if physics extensions were applied
                    const testVec = new THREE.Vector3(1, 2, 3);
                    if (typeof testVec.toPxVec3 === 'function') {
                        log('THREE.js physics extensions are applied', 'success');
                    } else {
                        log('THREE.js physics extensions not found (non-critical)', 'warn');
                    }
                }

                updateStatus('All tests passed!', 'loaded');
                log('✅ PhysX client loading test completed successfully!', 'success');

            } catch (error) {
                updateStatus('Test failed', 'failed');
                log(`❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Add THREE.js for testing
        window.THREE = {
            Vector3: class Vector3 {
                constructor(x, y, z) {
                    this.x = x;
                    this.y = y;
                    this.z = z;
                }
            },
            Quaternion: class Quaternion {
                constructor(x, y, z, w) {
                    this.x = x;
                    this.y = y;
                    this.z = z;
                    this.w = w;
                }
            }
        };

        // Start test
        testPhysXLoading();
    </script>
</body>
</html>